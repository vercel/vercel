/**
 * Syncs version from package.json to pyproject.toml for Python packages,
 * and also updates the generated version file in @vercel/python.
 *
 * This script is used during the changeset version process to ensure
 * Python packages have their pyproject.toml version updated when
 * changesets bumps the version in package.json.
 *
 * Usage: node utils/sync-python-version.js
 */

const fs = require('fs');
const path = require('path');

const VERSION_TS_PATH = 'packages/python/src/package-versions.ts';

const PYTHON_PACKAGES = [
  {
    name: '@vercel/python-runtime',
    packageJsonPath: 'python/vercel-runtime/package.json',
    pyprojectPath: 'python/vercel-runtime/pyproject.toml',
    versionExportName: 'VERCEL_RUNTIME_VERSION',
  },
  {
    name: '@vercel/python-workers',
    packageJsonPath: 'python/vercel-workers/package.json',
    pyprojectPath: 'python/vercel-workers/pyproject.toml',
    versionExportName: 'VERCEL_WORKERS_VERSION',
  },
];

function syncVersion(packageConfig) {
  const { name, packageJsonPath, pyprojectPath } = packageConfig;

  const packageJsonFullPath = path.join(__dirname, '..', packageJsonPath);
  const pyprojectFullPath = path.join(__dirname, '..', pyprojectPath);

  // Read package.json
  if (!fs.existsSync(packageJsonFullPath)) {
    console.log(
      `Skipping ${name}: package.json not found at ${packageJsonPath}`
    );
    return { updated: false, version: null };
  }

  const packageJson = JSON.parse(fs.readFileSync(packageJsonFullPath, 'utf8'));
  const version = packageJson.version;

  if (!version) {
    console.log(`Skipping ${name}: no version found in package.json`);
    return { updated: false, version: null };
  }

  // Read pyproject.toml
  if (!fs.existsSync(pyprojectFullPath)) {
    console.log(
      `Skipping ${name}: pyproject.toml not found at ${pyprojectPath}`
    );
    return { updated: false, version: null };
  }

  let pyprojectContent = fs.readFileSync(pyprojectFullPath, 'utf8');

  // Extract current version from pyproject.toml
  const versionMatch = pyprojectContent.match(/^version\s*=\s*"([^"]+)"/m);
  if (!versionMatch) {
    console.log(`Skipping ${name}: no version field found in pyproject.toml`);
    return { updated: false, version: null };
  }

  const currentPyVersion = versionMatch[1];
  let anyUpdated = false;

  if (currentPyVersion !== version) {
    // Update version in pyproject.toml
    pyprojectContent = pyprojectContent.replace(
      /^version\s*=\s*"[^"]+"/m,
      `version = "${version}"`
    );

    fs.writeFileSync(pyprojectFullPath, pyprojectContent);
    console.log(
      `${name}: synced pyproject.toml ${currentPyVersion} -> ${version}`
    );
    anyUpdated = true;
  } else {
    console.log(`${name}: pyproject.toml already in sync (${version})`);
  }

  return { updated: anyUpdated, version };
}

function syncVersionsInBuilderFile(versionExports) {
  const entries = Object.entries(versionExports).sort(([a], [b]) =>
    a.localeCompare(b)
  );

  if (entries.length === 0) {
    console.log(
      `Skipping ${VERSION_TS_PATH}: no Python package versions found`
    );
    return false;
  }

  const expectedContent = `// This file is auto-generated by utils/sync-python-version.js
// Do not edit manually.
${entries
  .map(([exportName, version]) => `export const ${exportName} = '${version}';`)
  .join('\n')}
`;
  const fullPath = path.join(__dirname, '..', VERSION_TS_PATH);

  if (!fs.existsSync(fullPath)) {
    fs.writeFileSync(fullPath, expectedContent);
    console.log(`Created ${VERSION_TS_PATH} with Python package versions`);
    return true;
  }

  const currentContent = fs.readFileSync(fullPath, 'utf8');

  if (currentContent === expectedContent) {
    console.log(`${VERSION_TS_PATH} already in sync`);
    return false;
  }

  fs.writeFileSync(fullPath, expectedContent);
  console.log(`Synced ${VERSION_TS_PATH} with Python package versions`);
  return true;
}

function main() {
  console.log(
    'Syncing Python package versions from package.json to pyproject.toml and generated version file...\n'
  );

  let anyUpdated = false;
  const versionExports = {};

  for (const packageConfig of PYTHON_PACKAGES) {
    try {
      const { updated, version } = syncVersion(packageConfig);
      if (updated) {
        anyUpdated = true;
      }
      if (version) {
        versionExports[packageConfig.versionExportName] = version;
      }
    } catch (error) {
      console.error(`Error syncing ${packageConfig.name}:`, error.message);
    }
  }

  if (Object.keys(versionExports).length === PYTHON_PACKAGES.length) {
    const versionFileUpdated = syncVersionsInBuilderFile(versionExports);
    if (versionFileUpdated) {
      anyUpdated = true;
    }
  } else {
    console.log(
      `Skipping ${VERSION_TS_PATH}: not all package versions could be resolved`
    );
  }

  if (anyUpdated) {
    console.log(
      '\nVersion sync complete. Remember to commit the updated files.'
    );
  } else {
    console.log('\nNo version changes needed.');
  }
}

main();
