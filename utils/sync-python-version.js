/**
 * Syncs version from package.json to pyproject.toml for Python packages,
 * and also updates generated version files in @vercel/python.
 *
 * This script is used during the changeset version process to ensure
 * Python packages have their pyproject.toml version updated when
 * changesets bumps the version in package.json.
 *
 * Usage: node utils/sync-python-version.js
 */

const fs = require('fs');
const path = require('path');

const PYTHON_PACKAGES = [
  {
    name: '@vercel/python-runtime',
    packageJsonPath: 'python/vercel-runtime/package.json',
    pyprojectPath: 'python/vercel-runtime/pyproject.toml',
    // Also sync to the generated version file consumed by @vercel/python.
    versionTsPath: 'packages/python/src/runtime-version.ts',
    versionExportName: 'VERCEL_RUNTIME_VERSION',
  },
  {
    name: '@vercel/python-workers',
    packageJsonPath: 'python/vercel-workers/package.json',
    pyprojectPath: 'python/vercel-workers/pyproject.toml',
    // Also sync to the generated version file consumed by @vercel/python.
    versionTsPath: 'packages/python/src/workers-version.ts',
    versionExportName: 'VERCEL_WORKERS_VERSION',
  },
];

function syncVersion(packageConfig) {
  const {
    name,
    packageJsonPath,
    pyprojectPath,
    versionTsPath,
    versionExportName,
  } = packageConfig;

  const packageJsonFullPath = path.join(__dirname, '..', packageJsonPath);
  const pyprojectFullPath = path.join(__dirname, '..', pyprojectPath);

  // Read package.json
  if (!fs.existsSync(packageJsonFullPath)) {
    console.log(
      `Skipping ${name}: package.json not found at ${packageJsonPath}`
    );
    return false;
  }

  const packageJson = JSON.parse(fs.readFileSync(packageJsonFullPath, 'utf8'));
  const version = packageJson.version;

  if (!version) {
    console.log(`Skipping ${name}: no version found in package.json`);
    return false;
  }

  // Read pyproject.toml
  if (!fs.existsSync(pyprojectFullPath)) {
    console.log(
      `Skipping ${name}: pyproject.toml not found at ${pyprojectPath}`
    );
    return false;
  }

  let pyprojectContent = fs.readFileSync(pyprojectFullPath, 'utf8');

  // Extract current version from pyproject.toml
  const versionMatch = pyprojectContent.match(/^version\s*=\s*"([^"]+)"/m);
  if (!versionMatch) {
    console.log(`Skipping ${name}: no version field found in pyproject.toml`);
    return false;
  }

  const currentPyVersion = versionMatch[1];
  let anyUpdated = false;

  if (currentPyVersion !== version) {
    // Update version in pyproject.toml
    pyprojectContent = pyprojectContent.replace(
      /^version\s*=\s*"[^"]+"/m,
      `version = "${version}"`
    );

    fs.writeFileSync(pyprojectFullPath, pyprojectContent);
    console.log(
      `${name}: synced pyproject.toml ${currentPyVersion} -> ${version}`
    );
    anyUpdated = true;
  } else {
    console.log(`${name}: pyproject.toml already in sync (${version})`);
  }

  // Sync to generated version file if configured.
  if (versionTsPath && versionExportName) {
    const versionTsFullPath = path.join(__dirname, '..', versionTsPath);
    const updated = syncVersionInBuilderFile(
      name,
      version,
      versionTsPath,
      versionTsFullPath,
      versionExportName
    );
    if (updated) {
      anyUpdated = true;
    }
  }

  return anyUpdated;
}

function syncVersionInBuilderFile(
  name,
  version,
  relativePath,
  fullPath,
  exportName
) {
  const expectedContent = `// This file is auto-generated by utils/sync-python-version.js
// Do not edit manually.
export const ${exportName} = '${version}';
`;

  if (!fs.existsSync(fullPath)) {
    fs.writeFileSync(fullPath, expectedContent);
    console.log(`${name}: created ${relativePath} with version ${version}`);
    return true;
  }

  const currentContent = fs.readFileSync(fullPath, 'utf8');

  if (currentContent === expectedContent) {
    console.log(`${name}: ${relativePath} already in sync (${version})`);
    return false;
  }

  fs.writeFileSync(fullPath, expectedContent);
  console.log(`${name}: synced ${relativePath} to version ${version}`);
  return true;
}

function main() {
  console.log(
    'Syncing Python package versions from package.json to pyproject.toml and generated version files...\n'
  );

  let anyUpdated = false;

  for (const packageConfig of PYTHON_PACKAGES) {
    try {
      const updated = syncVersion(packageConfig);
      if (updated) {
        anyUpdated = true;
      }
    } catch (error) {
      console.error(`Error syncing ${packageConfig.name}:`, error.message);
    }
  }

  if (anyUpdated) {
    console.log(
      '\nVersion sync complete. Remember to commit the updated files.'
    );
  } else {
    console.log('\nNo version changes needed.');
  }
}

main();
