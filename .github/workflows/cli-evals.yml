name: CLI Evals

# Runs on PRs only when evals change (to limit AI gateway cost). Also runnable manually via "Run workflow".
on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'packages/cli/evals/**'

jobs:
  evals:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # TODO: Remove continue-on-error when evals should block PR merge.
    continue-on-error: true
    # Evals use separate secrets (EVAL_*) so you can point to a dedicated evals team.
    # Same pattern as test.yml / test-e2e.yml: VERCEL_TOKEN + team/project IDs; add EVAL_AI_GATEWAY_API_KEY for the agent.
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install pnpm
        run: npm i -g pnpm@8.3.1

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build CLI
        if: false # skip for now; enable when monorepo build works in CI
        run: cd packages/cli && pnpm build

      - name: Run CLI evals
        id: evals
        run: cd packages/cli && pnpm test:evals
        env:
          AI_GATEWAY_API_KEY: ${{ secrets.EVAL_AI_GATEWAY_API_KEY }}
          VERCEL_TOKEN: ${{ secrets.EVAL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.EVAL_TEAM_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.EVAL_PROJECT_ID }}
          CLI_EVAL_TEAM_ID: ${{ secrets.EVAL_TEAM_ID }}
          CLI_EVAL_PROJECT_ID: ${{ secrets.EVAL_PROJECT_ID }}

      - name: Eval results detail (on failure)
        if: failure() && steps.evals.outcome == 'failure'
        run: |
          echo "=== Eval results directory ==="
          RESULTS_DIR="packages/cli/evals/results"
          if [ -d "$RESULTS_DIR" ]; then
            echo "Latest run:"
            LATEST=$(ls -t "$RESULTS_DIR/cli" 2>/dev/null | head -1)
            if [ -n "$LATEST" ]; then
              echo "  $RESULTS_DIR/cli/$LATEST"
              for f in "$RESULTS_DIR/cli/$LATEST"/*/summary.json "$RESULTS_DIR/cli/$LATEST"/*/run-*/outputs/eval.txt; do
                if [ -f "$f" ]; then
                  echo ""
                  echo "--- $f ---"
                  head -c 8000 "$f" | cat
                  [ $(wc -c < "$f") -gt 8000 ] && echo "... (truncated)"
                fi
              done
            fi
          else
            echo "No results directory found."
          fi
