name: Release Canary

on:
  workflow_dispatch:

env:
  TURBO_REMOTE_ONLY: 'true'
  TURBO_TEAM: 'vercel'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  # The "canary-release" environment must be configured in repo settings
  # with "vercel-cli-approvers" as a required reviewer. This is the only
  # way to gate a workflow_dispatch behind team approval in GitHub Actions.
  approve:
    name: Require Approval
    runs-on: ubuntu-latest
    environment: canary-release
    steps:
      - name: Approved
        run: echo "Release approved"

  release-canary:
    name: Release Canary
    needs: approve
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # 2025-12-16
        with:
          toolchain: stable
          targets: wasm32-wasip2

      - name: install npm@9
        run: npm i -g npm@9

      - name: install pnpm@8.3.1
        run: npm i -g pnpm@8.3.1

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Packages
        run: pnpm build
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Set Canary Versions
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          CANARY_SUFFIX="canary.${TIMESTAMP}.${SHORT_SHA}"

          # For each public package, append canary suffix to current version
          node -e "
            const fs = require('fs');
            const path = require('path');
            const glob = require('glob');
            const pkgPaths = glob.sync('packages/*/package.json');
            for (const pkgPath of pkgPaths) {
              const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
              if (pkg.private) continue;
              pkg.version = pkg.version + '-${CANARY_SUFFIX}';
              fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');
              console.log(pkg.name + '@' + pkg.version);
            }
          "

      - name: Publish Canary to npm
        run: pnpm publish -r --tag canary --no-git-checks
        env:
          NPM_CONFIG_PROVENANCE: 'true'
          NPM_TOKEN: ${{ secrets.NPM_TOKEN_ELEVATED }}
