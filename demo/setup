#!/usr/bin/env python3
import os
import re
import subprocess
import sys
from pathlib import Path

# ── Config ───────────────────────────────────────────────────────────
HOME = Path.home()
REPO_ROOT = Path(__file__).resolve().parent.parent
DEMO_OLD = HOME / "demo-old"
DEMO_NEW = HOME / "demo-new"
OLD_VERSION = "39.3.0"
TEAM_SLUG = "acme-marketplace-team-vtest314"
ZSHRC = HOME / ".zshrc"
STARSHIP = HOME / ".config" / "starship.toml"
MARKER_START = "# BEGIN-cli-demo-vc"
MARKER_END = "# END-cli-demo-vc"
STAR_START = "# BEGIN-cli-demo-starship"
STAR_END = "# END-cli-demo-starship"

GREEN = "\033[0;32m"
YELLOW = "\033[0;33m"
RED = "\033[0;31m"
NC = "\033[0m"


def step(msg):
    print(f"\n{GREEN}▶ {msg}{NC}")


def ok(msg):
    print(f"{GREEN}✓ {msg}{NC}")


def warn(msg):
    print(f"{YELLOW}⚠ {msg}{NC}")


def fail(msg):
    print(f"{RED}✗ {msg}{NC}")
    sys.exit(1)


def run(cmd, cwd=None, check=True):
    result = subprocess.run(cmd, cwd=cwd, capture_output=True, text=True)
    if check and result.returncode != 0:
        print(result.stdout)
        print(result.stderr)
        fail(f"Command failed: {' '.join(str(c) for c in cmd)}")
    return result


def run_visible(cmd, cwd=None):
    """Run with stdout/stderr visible to the user."""
    result = subprocess.run(cmd, cwd=cwd)
    if result.returncode != 0:
        fail(f"Command failed: {' '.join(str(c) for c in cmd)}")


def remove_block(filepath: Path, start: str, end: str):
    """Remove everything between start and end markers (inclusive)."""
    if not filepath.exists():
        return
    content = filepath.read_text()
    if start not in content:
        return
    pattern = re.escape(start) + r".*?" + re.escape(end) + r"\n?"
    filepath.write_text(re.sub(pattern, "", content, flags=re.DOTALL))


# ── 1. Create directories + git init ────────────────────────────────
step("Creating demo directories")
for d in [DEMO_OLD, DEMO_NEW]:
    d.mkdir(parents=True, exist_ok=True)

    if not (d / ".git").is_dir():
        run(["git", "init", "-q", "-b", "main"], cwd=d)

    # Always ensure .gitignore is up to date
    (d / ".gitignore").write_text("*\n!.gitignore\n.env*.local\n")

    # Commit everything so repos are clean
    run(["git", "add", "-A"], cwd=d)
    diff = run(["git", "diff", "--cached", "--quiet"], cwd=d, check=False)
    if diff.returncode != 0:
        run(["git", "commit", "-m", "setup", "-q"], cwd=d)
        ok(f"{d} (committed)")
    else:
        ok(f"{d} (already clean)")


# ── 2. Install old CLI ──────────────────────────────────────────────
step(f"Installing vercel@{OLD_VERSION} in {DEMO_OLD}")

pkg_json = DEMO_OLD / "package.json"
if not pkg_json.exists():
    pkg_json.write_text('{"private":true}\n')

old_bin = DEMO_OLD / "node_modules" / ".bin" / "vercel"
need_install = True

if old_bin.exists():
    result = run([str(old_bin), "--version"], check=False)
    installed = result.stdout.strip()
    if OLD_VERSION in installed:
        ok(f"Already installed: {installed}")
        need_install = False
    else:
        warn(f"Wrong version ({installed}), reinstalling...")

if need_install:
    run_visible(["pnpm", "install", f"vercel@{OLD_VERSION}"], cwd=DEMO_OLD)
    ok(f"Installed vercel@{OLD_VERSION}")


# ── 3. Build new CLI from source ────────────────────────────────────
step(f"Building new CLI from {REPO_ROOT}")
run_visible(["pnpm", "--filter", "vercel...", "build"], cwd=REPO_ROOT)

dist = REPO_ROOT / "packages" / "cli" / "dist" / "index.js"
if dist.exists():
    ok("Built: packages/cli/dist/index.js")
else:
    fail("Build failed — dist/index.js not found")


# ── 4. Install vc function in .zshrc ────────────────────────────────
step(f"Installing vc function in {ZSHRC}")

vc_block = f"""{MARKER_START}
# Auto-generated by demo/setup.py — safe to delete this whole block
vc() {{
  case "$PWD" in
    {DEMO_OLD}*)
      {old_bin} "$@"
      ;;
    {DEMO_NEW}*)
      FF_AUTO_PROVISION_INSTALL=1 node {dist} "$@"
      ;;
    *)
      echo "vc: not in a demo directory (~/demo-old or ~/demo-new)"
      return 1
      ;;
  esac
}}
alias demo-old="cd {DEMO_OLD}"
alias demo-new="cd {DEMO_NEW}"
alias demo-setup="{REPO_ROOT}/demo/setup"
alias demo-cleanup="{REPO_ROOT}/demo/cleanup"
alias demo-notes="{REPO_ROOT}/demo/notes-viewer"
{MARKER_END}
"""

# Remove existing block if present, then append fresh
remove_block(ZSHRC, MARKER_START, MARKER_END)
with open(ZSHRC, "a") as f:
    f.write(vc_block)
ok(f"Appended vc block to {ZSHRC}")


# ── 5. Install starship vc_version module ────────────────────────────
step(f"Installing vc_version in {STARSHIP}")

snippet_file = Path(__file__).resolve().parent / "starship-snippet.toml"
starship_block = snippet_file.read_text()
starship_content = STARSHIP.read_text()

# Add vc_version to format string if not already there
if "custom.vc_version" not in starship_content:
    starship_content = starship_content.replace(
        "${custom.git_branch_styled}\\",
        "${custom.git_branch_styled}\\\n${custom.vc_version}\\",
    )
    STARSHIP.write_text(starship_content)

# Remove existing block if present, then append fresh
remove_block(STARSHIP, STAR_START, STAR_END)
with open(STARSHIP, "a") as f:
    f.write("\n" + starship_block)
ok(f"Appended vc_version to {STARSHIP}")


# ── 6. Switch team scope ──────────────────────────────────────────────
step(f"Switching team to {TEAM_SLUG}")

run_visible([str(old_bin), "switch", TEAM_SLUG], cwd=DEMO_OLD)
ok(f"demo-old → {TEAM_SLUG}")

run_visible(
    ["node", str(dist), "switch", TEAM_SLUG],
    cwd=DEMO_NEW,
)
ok(f"demo-new → {TEAM_SLUG}")


# ── 7. Link to cli-test project ──────────────────────────────────────
PROJECT_JSON = '{"projectId":"prj_ZZysOqOQrAlGD0TLHwcS9WEqEqrZ","orgId":"team_ZrswwWlkgu3cRre7Tk7Rr0HV","projectName":"cli-test"}'
step("Linking to cli-test project")
for d in [DEMO_OLD, DEMO_NEW]:
    vercel_dir = d / ".vercel"
    vercel_dir.mkdir(exist_ok=True)
    (vercel_dir / "project.json").write_text(PROJECT_JSON + "\n")
    ok(f"{d.name} → cli-test")


# ── 8. Sanity checks ────────────────────────────────────────────────
step("Sanity checks")

old_ver = run([str(old_bin), "--version"], check=False).stdout.strip() or "FAILED"
print(f"  Old CLI: {old_ver}")

new_ver = run(["node", str(dist), "--version"], check=False).stdout.strip() or "FAILED"
print(f"  New CLI: {new_ver}")

if OLD_VERSION in old_ver:
    ok("Old version correct")
else:
    warn(f"Old version mismatch: expected {OLD_VERSION}, got {old_ver}")

print(f"""
{GREEN}═══════════════════════════════════════════════{NC}
{GREEN}  Setup complete. Open new terminal tabs.{NC}
{GREEN}═══════════════════════════════════════════════{NC}

  Aliases: demo-old, demo-new, demo-notes, demo-setup, demo-cleanup
""")
